# Stage 1: Builder
FROM python:3.11-slim AS builder

WORKDIR /app

# Upgrade pip and install uv + dev dependencies
RUN pip install --upgrade pip
RUN pip install uv pytest pytest-asyncio httpx

# Copy project files from root into container
COPY ../pyproject.toml ../uv.lock ./
RUN uv sync --dev

# Copy app source code and tests from root
COPY ../app ./app
COPY ../tests ./tests

# Set virtualenv path
ENV PATH="/app/.venv/bin:$PATH"

# Default command: run pytest
CMD ["pytest", "-v", "tests/integration"]
