# Stage 1: Builder
FROM python:3.11-slim AS builder

WORKDIR /app

# Upgrade pip and install uv + dev dependencies
RUN pip install --upgrade pip
RUN pip install uv pytest pytest-asyncio httpx

# Copy project dependency files and install dev dependencies
COPY pyproject.toml uv.lock ./
RUN uv sync --dev

# Copy app source code (including tests inside app/)
COPY app ./app

# Set virtualenv path
ENV PATH="/app/.venv/bin:$PATH"

# Set environment variables for test configuration
ENV ENV="test"
ENV DB_URI="${TEST_DB_URI}"
ENV REDIS_URL="${TEST_REDIS_URL}"
ENV JWT_SECRET_KEY="${TEST_JWT_SECRET_KEY}"

# Default command: run pytest (integration tests)
CMD ["pytest", "-v", "app/tests/integration"]
